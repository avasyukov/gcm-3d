# Пайплайн для В-сканов

Пайплайн сырой, не оч удобный, много где надо править руками. Если сразу доавтоматизировать, будет легче, но важно не перестараться.

Последовательность действий.

0. Рисуем аберратор - форму поверхности, которая будет разделять две среды. Это можно лапками, но есть уже насчитанное и есть тупенький скрипт (```tools/ndt/aberratorer.py```). Он просто пишет в файл (например, ```models/aberrator/sine_wide_low.txt```) одномерную "карту высот".

1. Пишем шаблонный таск (```tasks/tests/aberration_000.xml```). Нумерация такими трехзначными довольно удобная, когда надо много постановок подряд считать.
В самом таске надо следить, чтобы было правильное название наверху (в тэге prefix front) и внизу (emitter). Где название файла в mеsh лучше, чтобы тоже соответствовало.
Аберратор загружается как область другого материала (```area type="aberrator"```).
Плейсхолдер ```$TASKNUMBER$``` потом заменится на номер конкретного таска.
Плейсхолдеры ```"$XMIN$"``` и ```"$XMAX$"``` тоже потом заменяются на нужные координаты.
Это пока не настоящий таск. Это шаблон.

2. Генерим по шаблонному таску стопку настоящих. (скомпилировать и запустить ```tools/ndt/taskmaker_curve_bug.cpp```).
В этом скрипте надо написать правильный номер шаблонного таска, в двух местах. Появится стопка тасков (типа ```aberration_000_16.xml```), это уже настоящие таски, которые будут считаться.

3. Считаем стопку тасков. Можно руками раскидывать, можно скриптами (в ```aberration_0.sh - aberration_3.sh```) пример того, как раскидать на 4 узла 40 тасков.
Копирование-удаление файла с сеткой лечит неприятный сегфолт.
taskset - назначение процесса на ядро с определенным номером.
На выходе получаем стопку стопок vtu (не оч нужны) и стопку csv (оч нужны).

4. Берем стопку csv и прогоняем через скрипт.
```python3 tools/ndt/csv2png_for_set_of_pulses.py aberration_000 5 100```
Здесь 5 - это sys.argv[2] в скрипте. Это типа во сколько раз растянуть по вертикали - сколько раз дублировать каждую строку с данными. Нужен чисто для удобства, без этого лучей слишком мало.
100 - это на сколько пикселей обрезать начало сигнала. Там исходящий сигнал тоже записывается, амплитуда высокая, все засвечивает.
Из важного - в строке 15 можно выбрать, которую компоненту рисуем. Сейчас там стоит 3, то есть vz на сенсоре. 0 это время, 1-3 компоненты скорости, 4-9 компоненты тензора напряжений.
Получаем одну пнгшку, сам В-скан.

*5. Для отладки вот еще скрипт, может пригодиться:
```python3 tools/ndt/csv2png_for_single_pulse.py aberrator_000_00```
Это стопка А-сканов, то есть каждый горизонтальный ряд пикселей - это А-скан с одного элемента.

